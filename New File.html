<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamza | Premium Video Experience</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --gold-dark: #b8962e;
            --bg-black: #0b0b0b;
            --secondary-dark: #1a1a1a;
            --card-dark: #121212;
            --text-main: #f5f5f5;
            --text-light: #b5b5b5;
            --border: #2a2a2a;
            --accent-red: #ff4e45;
            --accent-green: #00c851;
            --accent-blue: #3ea6ff;
            --header-h: 64px;
            --sidebar-w: 260px;
            --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-black);
            color: var(--text-main);
            font-family: 'Open Sans', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3, .nav-logo, .btn-premium {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-black); }
        ::-webkit-scrollbar-thumb { 
            background: var(--gold); 
            border-radius: 10px;
            border: 2px solid var(--bg-black);
        }

        /* Layout */
        #app {
            display: grid;
            grid-template-areas: 
                "header header"
                "sidebar main";
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: var(--header-h) 1fr;
            min-height: 100vh;
        }

        /* Header */
        header {
            grid-area: header;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-h);
            background: rgba(11, 11, 11, 0.8);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gold);
            font-weight: 700;
            font-size: 1.4rem;
            letter-spacing: 1px;
            cursor: pointer;
            text-transform: uppercase;
        }

        .search-container {
            flex: 0 1 600px;
            position: relative;
            margin: 0 20px;
        }

        .search-bar {
            width: 100%;
            background: var(--secondary-dark);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 10px 20px;
            color: white;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-bar:focus { border-color: var(--gold); }

        .header-right { display: flex; align-items: center; gap: 15px; }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--gold);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            transition: background 0.3s;
        }

        .btn-icon:hover { background: rgba(212, 175, 55, 0.1); }

        .avatar-circle {
            width: 36px;
            height: 36px;
            background: var(--gold);
            color: black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        /* Sidebar */
        aside {
            grid-area: sidebar;
            position: fixed;
            top: var(--header-h);
            left: 0;
            bottom: 0;
            width: var(--sidebar-w);
            background: var(--bg-black);
            padding: 20px 10px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            z-index: 999;
            transition: transform 0.3s var(--ease);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            border-radius: 12px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 5px;
            text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
        }

        .sidebar-sep {
            height: 1px;
            background: var(--border);
            margin: 15px 10px;
        }

        .sidebar-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin: 10px 15px;
            letter-spacing: 1px;
        }

        /* Main Content */
        main {
            grid-area: main;
            padding: 20px;
            padding-top: 84px;
        }

        /* Category Pills */
        .categories {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 20px;
            scrollbar-width: none;
        }
        .categories::-webkit-scrollbar { display: none; }

        .pill {
            padding: 8px 18px;
            background: var(--secondary-dark);
            border: 1px solid var(--border);
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.25s var(--ease);
        }

        .pill.active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 40px 24px;
        }

        .video-card {
            cursor: pointer;
            transition: transform 0.3s var(--ease);
        }

        .video-card:hover { transform: translateY(-5px); }

        .thumbnail-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 14px;
            overflow: hidden;
            background: var(--secondary-dark);
            border: 1px solid var(--border);
            transition: border-color 0.3s;
        }

        .video-card:hover .thumbnail-container {
            border-color: rgba(212, 175, 55, 0.5);
        }

        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
        }

        .video-info {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .channel-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--secondary-dark);
            flex-shrink: 0;
        }

        .video-details h3 {
            font-size: 1rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .video-meta {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Watch Page Overlay */
        #watch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-black);
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }

        .watch-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        .player-section {
            width: 100%;
        }

        .video-player-wrapper {
            width: 100%;
            aspect-ratio: 16/9;
            background: black;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .video-player-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .watch-details {
            margin-top: 20px;
        }

        .watch-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .watch-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .action-btns { display: flex; gap: 10px; }
        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--secondary-dark);
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-main);
        }
        .action-btn:hover { background: var(--border); }

        .channel-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }

        .channel-info { display: flex; align-items: center; gap: 12px; }

        .btn-premium {
            background: var(--gold);
            color: black;
            border: none;
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-premium:hover { background: var(--gold-dark); }
        .btn-premium.subscribed {
            background: var(--secondary-dark);
            color: var(--text-light);
        }

        .description-box {
            background: var(--secondary-dark);
            padding: 15px;
            border-radius: 14px;
            font-size: 0.9rem;
            margin-top: 15px;
            line-height: 1.6;
        }

        /* Comments */
        .comments-section { margin-top: 30px; }
        .comment-input-row { display: flex; gap: 15px; margin-bottom: 25px; }
        .comment-input-row input {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            color: white;
            padding: 8px 0;
            outline: none;
        }
        .comment-input-row input:focus { border-color: var(--gold); }

        .comment-item { display: flex; gap: 15px; margin-bottom: 20px; }
        .comment-text-wrap { font-size: 0.95rem; }
        .comment-user { font-weight: bold; font-size: 0.85rem; margin-bottom: 4px; }
        .comment-time { color: var(--text-light); font-weight: normal; margin-left: 8px; }

        /* Studio Overlay */
        #studio-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-black);
            z-index: 3000;
            display: none;
            padding: 40px;
            overflow-y: auto;
        }

        .studio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2100);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
        }

        .stat-val { font-size: 2.5rem; color: var(--gold); font-weight: 700; margin-bottom: 5px; }

        .video-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--secondary-dark);
            border-radius: 14px;
            overflow: hidden;
        }

        .video-table th, .video-table td {
            text-align: left;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .video-table tr:hover { background: rgba(255,255,255,0.02); }

        /* Modal Base */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-dark);
            width: 90%;
            max-width: 500px;
            border-radius: 22px;
            padding: 40px;
            border: 1px solid var(--border);
            position: relative;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-light); font-size: 0.9rem; }
        .form-group input, .form-group textarea {
            width: 100%;
            background: var(--bg-black);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            color: white;
            outline: none;
        }
        .form-group input:focus { border-color: var(--gold); }

        /* Responsiveness */
        @media (max-width: 1000px) {
            #app { grid-template-columns: 1fr; grid-template-areas: "header" "main"; }
            aside { transform: translateX(-100%); }
            aside.open { transform: translateX(0); width: 260px; }
            .watch-container { grid-template-columns: 1fr; }
            .search-container { display: none; }
            .stats-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 600px) {
            .video-grid { grid-template-columns: 1fr; }
            .watch-actions { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>

    <div id="app">
        <header>
            <div class="header-left">
                <button class="btn-icon" id="menu-toggle">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <div class="nav-logo" onclick="location.reload()">
                    <span class="material-symbols-rounded" style="font-size: 32px;">play_circle</span>
                    Streamza
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Search premium videos..." id="main-search">
            </div>

            <div class="header-right" id="auth-header-actions">
                <button class="btn-premium" onclick="showAuthModal()">Sign In</button>
            </div>
        </header>

        <aside id="sidebar">
            <div class="nav-item active" onclick="showPage('home')">
                <span class="material-symbols-rounded">home</span>
                Home
            </div>
            <div class="nav-item" onclick="openStudio()">
                <span class="material-symbols-rounded">video_settings</span>
                Studio
            </div>
            <div class="nav-item" onclick="showHistory()">
                <span class="material-symbols-rounded">history</span>
                History
            </div>
            <div class="nav-item" onclick="showLiked()">
                <span class="material-symbols-rounded">thumb_up</span>
                Liked Videos
            </div>

            <div class="sidebar-sep"></div>
            <div class="sidebar-title">Subscriptions</div>
            <div id="sub-list">
                <div style="padding: 15px; font-size: 0.8rem; color: var(--text-light)">Sign in to see channels</div>
            </div>

            <div id="logout-section" style="display: none; margin-top: 20px;">
                <div class="sidebar-sep"></div>
                <div class="nav-item" onclick="handleLogout()" style="color: var(--accent-red)">
                    <span class="material-symbols-rounded">logout</span>
                    Sign Out
                </div>
            </div>
        </aside>

        <main id="main-content">
            <div class="categories" id="category-bar"></div>
            <div class="video-grid" id="main-video-grid"></div>
        </main>
    </div>

    <!-- Watch Overlay -->
    <div id="watch-overlay">
        <header style="position: sticky; top: 0; background: var(--bg-black)">
            <div class="header-left">
                <button class="btn-icon" onclick="closeWatch()">
                    <span class="material-symbols-rounded">arrow_back</span>
                </button>
                <div class="nav-logo">Streamza</div>
            </div>
        </header>

        <div class="watch-container">
            <div class="player-section">
                <div class="video-player-wrapper" id="player-container"></div>
                <div class="watch-details">
                    <h1 class="watch-title" id="w-title">Video Title</h1>
                    <div class="watch-actions">
                        <div class="video-meta" id="w-meta">1M views • 2 hours ago</div>
                        <div class="action-btns">
                            <div class="action-btn" onclick="toggleLike()">
                                <span class="material-symbols-rounded" id="like-icon">thumb_up</span>
                                <span id="like-count">0</span>
                            </div>
                            <div class="action-btn" onclick="alert('Streamza Dislike feature is private.')">
                                <span class="material-symbols-rounded">thumb_down</span>
                            </div>
                            <div class="action-btn" onclick="shareVideo()">
                                <span class="material-symbols-rounded">share</span>
                                Share
                            </div>
                        </div>
                    </div>

                    <div class="channel-row">
                        <div class="channel-info">
                            <div class="channel-avatar" id="w-avatar"></div>
                            <div>
                                <div style="font-weight: bold;" id="w-channel">Channel Name</div>
                                <div style="font-size: 0.8rem; color: var(--text-light)" id="w-sub-count">... subscribers</div>
                            </div>
                        </div>
                        <button class="btn-premium" id="sub-btn" onclick="toggleSub()">Subscribe</button>
                    </div>

                    <div class="description-box" id="w-desc"></div>

                    <div class="comments-section">
                        <h3 id="comment-count-text">0 Comments</h3>
                        <div class="comment-input-row">
                            <div class="avatar-circle" id="user-comment-avatar">?</div>
                            <input type="text" id="comment-input" placeholder="Add a premium comment...">
                            <button class="btn-premium" onclick="postComment()" style="padding: 6px 15px;">Post</button>
                        </div>
                        <div id="comments-list"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 style="margin-bottom: 15px;">Up Next</h3>
                <div id="up-next-list"></div>
            </div>
        </div>
    </div>

    <!-- Studio Overlay -->
    <div id="studio-overlay">
        <div class="studio-header">
            <h1 style="color: var(--gold)">Studio Dashboard</h1>
            <div style="display: flex; gap: 15px;">
                <button class="btn-premium" onclick="showUploadModal()">Upload Video</button>
                <button class="btn-icon" onclick="document.getElementById('studio-overlay').style.display='none'">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="st-total-v">0</div>
                <div style="color: var(--text-light)">Total Videos</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="st-total-views">0</div>
                <div style="color: var(--text-light)">Total Views</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="st-sub-count">0</div>
                <div style="color: var(--text-light)">Followers</div>
            </div>
        </div>

        <h2 style="margin-bottom: 20px;">My Videos</h2>
        <div style="overflow-x: auto;">
            <table class="video-table">
                <thead>
                    <tr>
                        <th>Video</th>
                        <th>Category</th>
                        <th>Views</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studio-video-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal" id="analytics-modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2 id="an-title" style="margin-bottom: 20px; color: var(--gold)">Analytics</h2>
            <div style="height: 300px;">
                <canvas id="analyticsChart"></canvas>
            </div>
            <button class="btn-premium" onclick="closeModal('analytics-modal')" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Upload/Edit Modal -->
    <div class="modal" id="upload-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 20px; color: var(--gold)">Upload to Streamza</h2>
            <div class="form-group">
                <label>Video Title</label>
                <input type="text" id="up-title" placeholder="Enter catchy title">
            </div>
            <div class="form-group">
                <label>Category</label>
                <input type="text" id="up-cat" placeholder="e.g. Music, Gaming">
            </div>
            <div class="form-group">
                <label>Thumbnail URL (External)</label>
                <input type="text" id="up-thumb" placeholder="https://image.com/img.jpg">
            </div>
            <div class="form-group">
                <label>Video URL (YouTube Embed or direct)</label>
                <input type="text" id="up-url" placeholder="https://youtube.com/embed/...">
            </div>
            <div class="form-group">
                <label>Duration</label>
                <input type="text" id="up-dur" placeholder="e.g. 10:45">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="up-desc" rows="3"></textarea>
            </div>
            <button class="btn-premium" style="width: 100%" id="btn-save-video" onclick="saveVideo()">Publish Now</button>
            <button class="btn-icon" style="position: absolute; top: 15px; right: 15px;" onclick="closeModal('upload-modal')">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="auth-modal">
        <div class="modal-content" style="text-align: center;">
            <span class="material-symbols-rounded" style="font-size: 60px; color: var(--gold); margin-bottom: 10px;">account_circle</span>
            <h2 style="margin-bottom: 10px;">Streamza Auth</h2>
            <p style="color: var(--text-light); margin-bottom: 30px;">Sign in to enjoy premium features</p>
            
            <div class="form-group" style="text-align: left;">
                <label>Email</label>
                <input type="email" id="auth-email">
            </div>
            <div class="form-group" style="text-align: left;">
                <label>Password</label>
                <input type="password" id="auth-pass">
            </div>

            <button class="btn-premium" style="width: 100%; margin-bottom: 15px;" onclick="handleEmailLogin()">Sign In / Sign Up</button>
            <div style="color: var(--text-light); margin-bottom: 15px;">OR</div>
            <button class="btn-premium" style="width: 100%; background: white; color: black;" onclick="handleGoogleLogin()">
                Continue with Google
            </button>
            
            <button class="btn-icon" style="position: absolute; top: 15px; right: 15px;" onclick="closeModal('auth-modal')">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, increment, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7kxfFfysCUABqf3oTeHAODZmp13m20d0",
            authDomain: "fir-4f6b0.firebaseapp.com",
            databaseURL: "https://fir-4f6b0-default-rtdb.firebaseio.com",
            projectId: "fir-4f6b0",
            storageBucket: "fir-4f6b0.firebasestorage.app",
            messagingSenderId: "21311397980",
            appId: "1:21311397980:web:8a7fc3859e109756c8c699"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // App State
        let currentUser = null;
        let allVideos = [];
        let currentWatchId = null;
        let myVideos = [];
        let currentEditingId = null;
        let analyticsChart = null;
        let currentWatchVideo = null;

        const categories = ["All", "Music", "Gaming", "Code", "News", "Sports", "Live", "Learning", "Java", "Python", "Vlogs", "Comedy"];

        // Expose functions to global window object
        window.handleEmailLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if(!email || !pass) return;

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                window.closeModal('auth-modal');
            } catch (err) {
                if(err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential' || err.code === 'auth/invalid-email') {
                    try {
                        await createUserWithEmailAndPassword(auth, email, pass);
                        window.closeModal('auth-modal');
                    } catch(e) { alert(e.message); }
                } else { alert(err.message); }
            }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                window.closeModal('auth-modal');
            } catch (err) { alert(err.message); }
        };

        window.handleLogout = async () => {
            if(confirm("Sign out of Streamza?")) {
                await signOut(auth);
                location.reload();
            }
        };

        window.showAuthModal = () => document.getElementById('auth-modal').style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.openStudio = () => {
            if(!currentUser) return window.showAuthModal();
            document.getElementById('studio-overlay').style.display = 'block';
            filterMyVideos();
        };

        window.showPage = (type) => {
            if(type === 'home') {
                document.getElementById('watch-overlay').style.display = 'none';
                document.getElementById('studio-overlay').style.display = 'none';
            }
        };

        window.openWatch = (id) => {
            currentWatchId = id;
            const v = allVideos.find(x => x.id === id);
            if(!v) return;
            currentWatchVideo = v;

            update(ref(db, `videos/${id}`), { views: increment(1) });
            push(ref(db, `analytics/${id}/views`), { t: Date.now() });

            if(currentUser) {
                push(ref(db, `users/${currentUser.uid}/history`), { videoId: id, timestamp: Date.now() });
            }

            document.getElementById('watch-overlay').style.display = 'block';
            document.getElementById('w-title').innerText = v.title;
            document.getElementById('w-meta').innerText = `${v.views || 0} views • ${formatTime(v.timestamp)}`;
            document.getElementById('w-channel').innerText = v.uploader;
            document.getElementById('w-desc').innerText = v.description;
            document.getElementById('w-avatar').innerText = v.uploader[0];
            document.getElementById('w-avatar').style.background = 'var(--gold)';
            document.getElementById('w-avatar').style.display = 'flex';
            document.getElementById('w-avatar').style.alignItems = 'center';
            document.getElementById('w-avatar').style.justifyContent = 'center';
            document.getElementById('w-avatar').style.fontWeight = 'bold';
            document.getElementById('w-avatar').style.color = 'black';

            const container = document.getElementById('player-container');
            let url = v.videoUrl;
            if(url.includes('youtube.com/watch?v=')) {
                const vidId = url.split('v=')[1].split('&')[0];
                url = `https://www.youtube.com/embed/${vidId}?autoplay=1`;
            } else if(url.includes('youtu.be/')) {
                const vidId = url.split('youtu.be/')[1];
                url = `https://www.youtube.com/embed/${vidId}?autoplay=1`;
            }
            container.innerHTML = `<iframe src="${url}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;

            loadComments(id);
            loadLikes(id);
            renderUpNext(id);
            updateSubscriptionUI(v.uid);
        };

        window.closeWatch = () => {
            document.getElementById('watch-overlay').style.display = 'none';
            document.getElementById('player-container').innerHTML = '';
            currentWatchVideo = null;
        };

        window.postComment = () => {
            if(!currentUser) return window.showAuthModal();
            const text = document.getElementById('comment-input').value;
            if(!text) return;

            push(ref(db, `comments/${currentWatchId}`), {
                text,
                user: currentUser.displayName || currentUser.email.split('@')[0],
                uid: currentUser.uid,
                time: Date.now()
            });
            document.getElementById('comment-input').value = '';
        };

        window.toggleLike = () => {
            if(!currentUser) return window.showAuthModal();
            const lRef = ref(db, `likes/${currentWatchId}/${currentUser.uid}`);
            get(lRef).then((snapshot) => {
                if(snapshot.exists()) {
                    remove(lRef);
                } else {
                    set(lRef, true);
                }
            });
        };

        window.toggleSub = async () => {
            if(!currentUser) return window.showAuthModal();
            if(!currentWatchVideo) return;
            const targetUid = currentWatchVideo.uid;
            if(targetUid === currentUser.uid) return alert("You cannot subscribe to yourself.");

            const subRef = ref(db, `subscriptions/${currentUser.uid}/${targetUid}`);
            const followerRef = ref(db, `followers/${targetUid}/${currentUser.uid}`);
            
            const snapshot = await get(subRef);
            if(snapshot.exists()) {
                await remove(subRef);
                await remove(followerRef);
                await update(ref(db, `users_meta/${targetUid}`), { subs: increment(-1) });
            } else {
                await set(subRef, { uploader: currentWatchVideo.uploader, timestamp: Date.now() });
                await set(followerRef, true);
                await update(ref(db, `users_meta/${targetUid}`), { subs: increment(1) });
            }
            updateSubscriptionUI(targetUid);
        };

        window.saveVideo = async () => {
            const videoData = {
                title: document.getElementById('up-title').value,
                category: document.getElementById('up-cat').value,
                thumbnail: document.getElementById('up-thumb').value,
                videoUrl: document.getElementById('up-url').value,
                duration: document.getElementById('up-dur').value,
                description: document.getElementById('up-desc').value,
                uid: currentUser.uid,
                uploader: currentUser.displayName || currentUser.email.split('@')[0],
                timestamp: Date.now()
            };

            if(!videoData.title || !videoData.videoUrl) return alert("Title and URL are required");

            if(currentEditingId) {
                await update(ref(db, `videos/${currentEditingId}`), videoData);
            } else {
                videoData.views = 0;
                await push(ref(db, 'videos'), videoData);
            }
            window.closeModal('upload-modal');
        };

        window.showUploadModal = () => {
            currentEditingId = null;
            document.getElementById('modal-title').innerText = "Upload to Streamza";
            document.getElementById('btn-save-video').innerText = "Publish Now";
            document.getElementById('upload-modal').style.display = 'flex';
            ['up-title', 'up-cat', 'up-thumb', 'up-url', 'up-dur', 'up-desc'].forEach(id => document.getElementById(id).value = '');
        };

        window.editVideo = (id) => {
            const v = myVideos.find(x => x.id === id);
            currentEditingId = id;
            document.getElementById('modal-title').innerText = "Edit Streamza Video";
            document.getElementById('btn-save-video').innerText = "Save Changes";
            document.getElementById('up-title').value = v.title;
            document.getElementById('up-cat').value = v.category;
            document.getElementById('up-thumb').value = v.thumbnail;
            document.getElementById('up-url').value = v.videoUrl;
            document.getElementById('up-dur').value = v.duration;
            document.getElementById('up-desc').value = v.description;
            document.getElementById('upload-modal').style.display = 'flex';
        };

        window.deleteVideo = async (id) => {
            if(confirm("Permanently delete this video?")) {
                await remove(ref(db, `videos/${id}`));
            }
        };

        window.openAnalytics = (id) => {
            const v = allVideos.find(x => x.id === id);
            document.getElementById('an-title').innerText = `Analytics: ${v.title}`;
            document.getElementById('analytics-modal').style.display = 'flex';
            const analyticsRef = ref(db, `analytics/${id}/views`);
            onValue(analyticsRef, (snapshot) => {
                const data = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderChart(data);
            }, { onlyOnce: true });
        };

        window.filterByCategory = (cat, el) => {
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            const filtered = cat === 'All' ? allVideos : allVideos.filter(v => v.category === cat);
            renderVideoGrid(filtered);
        };

        window.shareVideo = () => {
            const dummy = document.createElement('input');
            document.body.appendChild(dummy);
            dummy.value = `Streamza Video: ${allVideos.find(v=>v.id===currentWatchId).title}`;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            alert("Share link copied to clipboard");
        };

        window.showHistory = () => {
            if(!currentUser) return window.showAuthModal();
            alert("History feature under premium maintenance.");
        };

        window.showLiked = () => {
            if(!currentUser) return window.showAuthModal();
            alert("Opening liked video vault.");
        };

        // Internal Logic
        function updateSubscriptionUI(targetUid) {
            const btn = document.getElementById('sub-btn');
            const countEl = document.getElementById('w-sub-count');
            
            onValue(ref(db, `users_meta/${targetUid}`), (snapshot) => {
                const meta = snapshot.val() || { subs: 0 };
                countEl.innerText = `${meta.subs} subscribers`;
            });

            if(currentUser) {
                onValue(ref(db, `subscriptions/${currentUser.uid}/${targetUid}`), (snapshot) => {
                    if(snapshot.exists()) {
                        btn.innerText = "Subscribed";
                        btn.classList.add('subscribed');
                    } else {
                        btn.innerText = "Subscribe";
                        btn.classList.remove('subscribed');
                    }
                });
            }
        }

        function loadUserData() {
            filterMyVideos();
            loadSidebarSubscriptions();
            loadStudioStats();
        }

        function loadStudioStats() {
            if(!currentUser) return;
            onValue(ref(db, `users_meta/${currentUser.uid}`), (snapshot) => {
                const meta = snapshot.val() || { subs: 0 };
                document.getElementById('st-sub-count').innerText = meta.subs;
            });
        }

        function loadSidebarSubscriptions() {
            if(!currentUser) return;
            onValue(ref(db, `subscriptions/${currentUser.uid}`), (snapshot) => {
                const subs = snapshot.val() ? Object.values(snapshot.val()) : [];
                const list = document.getElementById('sub-list');
                if(subs.length === 0) {
                    list.innerHTML = `<div style="padding: 15px; font-size: 0.8rem; color: var(--text-light)">No subscriptions yet</div>`;
                } else {
                    list.innerHTML = subs.map(s => `
                        <div class="nav-item">
                            <div class="avatar-circle" style="width: 24px; height: 24px; font-size: 0.7rem;">${s.uploader[0]}</div>
                            <span style="font-size: 0.9rem;">${s.uploader}</span>
                        </div>
                    `).join('');
                }
            });
        }

        function filterMyVideos() {
            myVideos = allVideos.filter(v => v.uid === (currentUser?.uid || ''));
            renderStudio();
        }

        function renderStudio() {
            const list = document.getElementById('studio-video-list');
            let totalViews = 0;
            list.innerHTML = myVideos.map(v => {
                totalViews += (v.views || 0);
                return `
                    <tr>
                        <td>
                            <div style="display:flex; gap: 10px; align-items:center">
                                <img src="${v.thumbnail}" style="width: 60px; height: 34px; border-radius: 4px; object-fit: cover">
                                <div>${v.title}</div>
                            </div>
                        </td>
                        <td>${v.category}</td>
                        <td>${v.views || 0}</td>
                        <td>${new Date(v.timestamp).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-icon" style="display:inline" onclick="openAnalytics('${v.id}')"><span class="material-symbols-rounded">analytics</span></button>
                            <button class="btn-icon" style="display:inline" onclick="editVideo('${v.id}')"><span class="material-symbols-rounded">edit</span></button>
                            <button class="btn-icon" style="display:inline; color: var(--accent-red)" onclick="deleteVideo('${v.id}')"><span class="material-symbols-rounded">delete</span></button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('st-total-v').innerText = myVideos.length;
            document.getElementById('st-total-views').innerText = totalViews;
        }

        function loadVideos() {
            onValue(ref(db, 'videos'), (snapshot) => {
                const data = snapshot.val();
                allVideos = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })) : [];
                renderVideoGrid(allVideos);
                if(currentUser) filterMyVideos();
            });
        }

        function renderVideoGrid(videos) {
            const grid = document.getElementById('main-video-grid');
            grid.innerHTML = videos.map(v => `
                <div class="video-card" onclick="openWatch('${v.id}')">
                    <div class="thumbnail-container">
                        <img src="${v.thumbnail || 'https://via.placeholder.com/640x360'}" onerror="this.src='https://via.placeholder.com/640x360'">
                        <div class="duration-badge">${v.duration || '0:00'}</div>
                    </div>
                    <div class="video-info">
                        <div class="channel-avatar" style="background: var(--gold); display: flex; align-items: center; justify-content: center; font-weight: bold; color: black">
                            ${v.uploader ? v.uploader[0].toUpperCase() : '?'}
                        </div>
                        <div class="video-details">
                            <h3>${v.title}</h3>
                            <div class="video-meta">
                                ${v.uploader}<br>
                                ${v.views || 0} views • ${formatTime(v.timestamp)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadComments(vidId) {
            onValue(ref(db, `comments/${vidId}`), (snapshot) => {
                const data = snapshot.val();
                const list = data ? Object.values(data).reverse() : [];
                document.getElementById('comment-count-text').innerText = `${list.length} Comments`;
                document.getElementById('comments-list').innerHTML = list.map(c => `
                    <div class="comment-item">
                        <div class="avatar-circle" style="width: 32px; height: 32px; font-size: 0.8rem;">${c.user ? c.user[0].toUpperCase() : '?'}</div>
                        <div class="comment-text-wrap">
                            <div class="comment-user">${c.user} <span class="comment-time">${formatTime(c.time)}</span></div>
                            <div>${c.text}</div>
                        </div>
                    </div>
                `).join('');
            });
        }

        function loadLikes(vidId) {
            onValue(ref(db, `likes/${vidId}`), (snapshot) => {
                const data = snapshot.val() || {};
                const count = Object.keys(data).length;
                document.getElementById('like-count').innerText = count;
                const icon = document.getElementById('like-icon');
                icon.style.color = (currentUser && data[currentUser.uid]) ? 'var(--gold)' : 'white';
            });
        }

        function renderUpNext(currentId) {
            const next = allVideos.filter(v => v.id !== currentId).slice(0, 8);
            const container = document.getElementById('up-next-list');
            container.innerHTML = next.map(v => `
                <div style="display: flex; gap: 10px; margin-bottom: 12px; cursor: pointer" onclick="openWatch('${v.id}')">
                    <div style="width: 140px; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden">
                        <img src="${v.thumbnail}" style="width:100%; height:100%; object-fit:cover">
                    </div>
                    <div style="flex: 1">
                        <div style="font-weight: bold; font-size: 0.85rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${v.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 4px;">${v.uploader}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderChart(viewData) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            if(analyticsChart) analyticsChart.destroy();
            const hourly = Array(24).fill(0);
            viewData.forEach(v => {
                const hr = new Date(v.t).getHours();
                hourly[hr]++;
            });
            analyticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Views (Last 24h)',
                        data: hourly,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#2a2a2a' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function formatTime(ts) {
            if(!ts) return "recently";
            const diff = (Date.now() - ts) / 1000;
            if(diff < 60) return "Just now";
            if(diff < 3600) return `${Math.floor(diff/60)}m ago`;
            if(diff < 86400) return `${Math.floor(diff/3600)}h ago`;
            return `${Math.floor(diff/86400)}d ago`;
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const container = document.getElementById('auth-header-actions');
            const logoutSection = document.getElementById('logout-section');
            if (user) {
                const initial = user.displayName ? user.displayName[0] : (user.email ? user.email[0].toUpperCase() : '?');
                container.innerHTML = `
                    <button class="btn-icon" onclick="openStudio()"><span class="material-symbols-rounded">video_call</span></button>
                    <button class="btn-icon"><span class="material-symbols-rounded">notifications</span></button>
                    <div class="avatar-circle" onclick="document.getElementById('sidebar').classList.toggle('open')">${initial}</div>
                `;
                logoutSection.style.display = 'block';
                document.getElementById('user-comment-avatar').innerText = initial;
                loadUserData();
            } else {
                container.innerHTML = `<button class="btn-premium" onclick="showAuthModal()">Sign In</button>`;
                logoutSection.style.display = 'none';
                document.getElementById('sub-list').innerHTML = `<div style="padding: 15px; font-size: 0.8rem; color: var(--text-light)">Sign in to see channels</div>`;
            }
        });

        // Init
        document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('open'));
        document.getElementById('main-search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allVideos.filter(v => v.title.toLowerCase().includes(term));
            renderVideoGrid(filtered);
        });

        const bar = document.getElementById('category-bar');
        bar.innerHTML = categories.map(cat => `<div class="pill ${cat==='All'?'active':''}" onclick="filterByCategory('${cat}', this)">${cat}</div>`).join('');
        
        loadVideos();
    </script>
</body>
</html>